<script>
// ---------- CONFIG PLANILHA ----------
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbw8rJqSLJZ1szuXzLU4L3KAHrF1X2BqEPdZgRrzxw6l7C2J4sIhB8lT5O5lVqvI4h7pQ/exec';

// ---------- UTIL ----------
function $(id){return document.getElementById(id);}
function hideAll(){document.querySelectorAll('.container').forEach(d=>d.classList.add('hidden'));}
function voltar(){hideAll();$('loginScreen').classList.remove('hidden');}
function ir(p){
  hideAll();
  $(p+'Screen').classList.remove('hidden');
  if(p==='chefe')lista();   // ← chama lista ao abrir
  if(p==='admin')relat();   // ← chama relatório ao abrir
}
function tela(t){hideAll();$(t+'Screen').classList.remove('hidden');}

// ---------- REGISTRAR ----------
function registrar(ev,tipo){
  ev.preventDefault();
  const cliente=tipo==='saída'?$('sCliente').value:$('rCliente').value;
  const qtd=tipo==='saída'?parseInt($('sQtd').value):parseInt($('rQtd').value);
  const data=new Date().toLocaleString('pt-BR');
  fetch(SHEET_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:Date.now(),data,cliente,tipo,qtd,status:'pendente'})})
  .then(r=>r.text()).then(d=>{if(d==='ok')alert('Salvo na nuvem!');else alert('Erro');});
  ev.target.reset();
  ir('motorista');
}

// ---------- LISTAR / RELAT ----------
function lista(){
  fetch(SHEET_URL).then(r=>r.json()).then(rows=>{
    const lista=rows.filter(r=>r.status==='pendente');
    let html='';
    if(!lista.length)html='<p class="alert alert-info">Nada pendente.</p>';
    lista.forEach(r=>{
      html+=`<div class="summary-card"><b>${r.tipo} #${r.id}</b><br>Cliente: ${r.cliente}<br>Qtd: ${r.qtd} pallets<br>Data: ${r.data}<br><label>Confirma:</label><input type="number" id="conf${r.id}" value="${r.qtd}" min="0"><br><button class="btn-success" onclick="confirma(${r.id})">Confirmar</button></div>`;
    });
    $('pendente').innerHTML=html;
  });
}
function confirma(id){
  const qtd=parseInt($('conf'+id).value);
  const dif=qtd-parseInt(document.querySelector(`#conf${id}`).placeholder);
  fetch(SHEET_URL,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,qtdConf:qtd,status:'confirmado',dif})})
  .then(r=>r.text()).then(d=>{alert('Confirmado!');lista();});
}
function relat(){
  fetch(SHEET_URL).then(r=>r.json()).then(rows=>{
    const tbody=$('tbl').tBodies[0];
    tbody.innerHTML='';
    let totS=0,totR=0;
    rows.forEach(r=>{
      if(r.status==='confirmado'){
        if(r.tipo==='saída')totS+=parseInt(r.qtdConf||r.qtd);
        else totR+=parseInt(r.qtdConf||r.qtd);
      }
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.data}</td><td>${r.cliente}</td><td>${r.tipo}</td><td>${r.qtdConf||r.qtd}</td><td>${r.status}</td>`;
      tbody.appendChild(tr);
    });
    $('resumo').innerHTML=`Total enviado: <b>${totS}</b> | Total retornado: <b>${totR}</b> | Faltando: <b>${totS-totR}</b>`;
  });
}
</script>
