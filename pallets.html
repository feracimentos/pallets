<script>
const DB_URL = 'https://pallets-5dcd8-default-rtdb.firebaseio.com';
let db = [];

// --------- UTILIDADES ----------
function $(id){return document.getElementById(id);}
function hideAll(){document.querySelectorAll('.container').forEach(d=>d.classList.add('hidden'));}
function voltar(){hideAll();$('loginScreen').classList.remove('hidden');}
function ir(p){hideAll();$(p+'Screen').classList.remove('hidden');if(p==='chefe')lista();if(p==='admin')relat();}
function tela(t){hideAll();$(t+'Screen').classList.remove('hidden');}

// --------- FIREBASE FUNÇÕES ----------
async function carregarDB(){
  const res = await fetch(`${DB_URL}/pallets.json`);
  const data = await res.json();
  db = data ? Object.entries(data).map(([key,val])=>({...val, firebaseId:key})) : [];
}

async function salvarRegistro(registro){
  await fetch(`${DB_URL}/pallets.json`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(registro)
  });
}

async function atualizarRegistro(id,registro){
  await fetch(`${DB_URL}/pallets/${id}.json`,{
    method:'PATCH',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(registro)
  });
}

// --------- REGISTRAR ----------
async function registrar(ev,tipo){
  ev.preventDefault();
  const m={
    tipo,
    cliente:tipo==='saída'?$('sCliente').value:$('rCliente').value,
    quantidade:tipo==='saída'?parseInt($('sQtd').value):parseInt($('rQtd').value),
    dataHora:new Date().toLocaleString('pt-BR'),
    status:'pendente',
    qtdConf:null,
    dif:null
  };
  await salvarRegistro(m);
  alert('Enviado com sucesso!');
  ev.target.reset();
  ir('motorista');
}

// --------- LISTAR / CONFIRMAR ----------
async function lista(){
  await carregarDB();
  const pendentes=db.filter(r=>r.status==='pendente');
  let html='';
  if(!pendentes.length)html='<p class="alert alert-info">Nada pendente.</p>';
  pendentes.forEach(r=>{
    html+=`<div class="summary-card"><b>${r.tipo}</b><br>Cliente: ${r.cliente}<br>Qtd: ${r.quantidade}<br>Data: ${r.dataHora}<br><label>Confirma:</label><input type="number" id="conf${r.firebaseId}" value="${r.quantidade}" min="0"><br><button onclick="confirmar('${r.firebaseId}', ${r.quantidade})">Confirmar</button></div>`;
  });
  $('pendente').innerHTML=html;
}

async function confirmar(id,originalQtd){
  const qtdConf=parseInt($('conf'+id).value);
  const dif=qtdConf-originalQtd;
  await atualizarRegistro(id,{status:'confirmado',qtdConf,dif});
  alert('Confirmado!'+(dif?' Diferença: '+dif:''));
  lista();
}

// --------- RELATÓRIO ----------
async function relat(){
  await carregarDB();
  const tbody=$('tbl').tBodies[0];
  tbody.innerHTML='';
  let totS=0,totR=0;
  db.forEach(r=>{
    if(r.status==='confirmado'){
      if(r.tipo==='saída')totS+=r.qtdConf;
      else totR+=r.qtdConf;
    }
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.dataHora}</td><td>${r.cliente}</td><td>${r.tipo}</td><td>${r.qtdConf||r.quantidade}</td><td>${r.status==='confirmado'?'✅':'⏳'}</td>`;
    tbody.appendChild(tr);
  });
  $('resumo').innerHTML=`Total saída: <b>${totS}</b> | Total retorno: <b>${totR}</b> | Faltando: <b>${totS-totR}</b>`;
}

// --------- EXPORTAR ----------
function exportExcel(){
  let csv='Data\tCliente\tTipo\tQtd Registrada\tQtd Confirmada\tStatus\tDiferença\n';
  db.forEach(r=>{csv+=`${r.dataHora}\t${r.cliente}\t${r.tipo}\t${r.quantidade}\t${r.qtdConf||''}\t${r.status}\t${r.dif||''}\n`;});
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const link=document.createElement('a');
  link.href=URL.createObjectURL(blob);
  link.download='pallets_'+new Date().toISOString().slice(0,10)+'.csv';
  link.click();
}
</script>
